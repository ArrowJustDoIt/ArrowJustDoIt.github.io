---
layout: post
title: Cookie与Session -- 原理
category: 技术
tags: php
keywords: 
description: 
---

之前有写过一篇[Cookie与Session](http://arrowjustdoit.github.io/2014/05/25/Cookie-and-Session.html)更多是在讲解写简单的实际操作,今天在网上看到一些通俗易懂的原理,分享下
***

###**作用**

　　服务器可以`利用Cookies或Session包含信息的任意性来筛选并经常性维护这些信息`，以判断在HTTP传输中的状态。它们最典型的应用是`判定注册用户是否已经登录网站`，用户可能会得到提示，是否在下一次进入此网站时保留用户信息以便简化登录手续。另一个重要应用场合是`“购物车”`之类处理。用户可能会在一段时间内在同一家网站的不同页面中选择不同的商品，这些信息都会写入Cookies或Session，以便在最后付款时提取信息。总而言之，cookies和session就是能够`记录顾客状态`的技术，尽管二者属于不同的技术，但只要cookies能做到的，session也能做到

###**打个比方**

　　我常到一家熟食店买馋嘴鸭，该店老板为了促进销售，特发布“每购满10只即可免费赠送一只”的优惠措施。除了家里有什么红白喜事要飨客之外，应该不会有人一次性购买10只烤鸭吧？所以老板得想个法子来记录顾客的消费数量，这里总共有三种方案：

   Ⅰ、老板`记住每一个顾客的消费数量`，等到顾客消费满10只的时候自动奉送一只。这好比HTTP协议本身是有状态的，可以记住顾客的活动行为。但遗憾的是，出于种种考虑`http协议本身是不能有状态的`，老板自个也没有这么超常的记忆力，故这种方案行不通！

   Ⅱ、老板发给顾客一张`积分卡`，上面记录着消费的数量，一般还有个有效期限。每次买烤鸭时，如果顾客出示这张卡片，老板就知道这位顾客曾经光顾过小店。这种做法就是在`客户端保持状态`，好比是cookie技术。打开（windows系统）C:\Documents and Settings\用户名\Cookies，你会发现一些*.txt格式的小文件，这就是你浏览某些网站，它们发给你的“积分卡”(cookies)。

   Ⅲ、老板发给顾客一张`会员卡`，`除了卡号之外什么信息也不纪录`，每次买烤鸭时，如果顾客出示该卡片，则老板搬出店里的划名册，找到你的卡号并加1个积分。这种做法就是在`服务器端保持状态`。好比是session技术。

###**区别和联系**

cookie和session最大的区别在于： 

- cookie是把`积分卡`发给顾客，上面`记录了顾客所有的消费信息`。Session则是把只有`卡号`(session id)的积分卡发给顾客，`自家记录了顾客所有的消费信息`。

- Cookie是保存在`客户端`的；session是保存在`服务器端`，而session id则是保存在`客户端`，通常也是一个cookie小文件，由于这个小文件除了session id(好比卡号)外什么也没有，因此比cookie安全多了。

具体来说cookie机制采用的是在`客户端保持状态`的方案，而session机制采用的是在`服务器端保持状态`的方案。同时我们也看到，由于采用服务器端保持状态的方案在客户端也需要保存一个标识，所以session机制可能需要借助于cookie机制来达到保存标识的目的，但实际上它还有其他选择。

###**原理**

###cookie机制

　　正统的cookie分发是通过扩展HTTP协议来实现的，服务器通过在HTTP的响应头中加上一行特殊的指示以提示浏览器按照指示生成相应的cookie。然而纯粹的客户端脚本如JavaScript或者VBScript也可以生成cookie。而cookie的使用是由浏览器按照一定的原则在后台自动发送给服务器的。浏览器检查所有存储的cookie，如果某个cookie所声明的作用范围大于等于将要请求的资源所在的位置，则把该cookie附在请求资源的HTTP请求头上发送给服务器。

cookie的内容主要包括：名字，值，过期时间，路径和域。路径与域一起构成cookie的作用范围。若不设置过期时间，则表示这个cookie的生命期为浏览器会话期间，关闭浏览器窗口，cookie就消失。这种生命期为浏览器会话期的cookie被称为`会话cookie`。会话cookie一般不存储在硬盘上而是保存在内存里，当然这种行为并不是规范规定的。若设置了过期时间，浏览器就会把cookie保存到硬盘上，关闭后再次打开浏览器，这些cookie仍然有效直到超过设定的过期时间。存储在硬盘上的cookie可以在不同的浏览器进程间共享，比如两个IE窗口。而对于保存在内存里的cookie，不同的浏览器有不同的处理方式

###session机制

　　session机制是一种服务器端的机制，服务器使用一种类似于散列表的结构（也可能就是使用散列表）来保存信息。当程序需要为某个客户端的请求创建一个session时，服务器首先检查这个客户端的请求里是否已包含了一个session标识（称为session id），如果已包含则说明以前已经为此客户端创建过session，服务器就按照session id把这个session检索出来使用（检索不到，会新建一个），如果客户端请求不包含session id，则为此客户端创建一个session并且生成一个与此session相关联的session id，session id的值应该是一个既不会重复，又不容易被找到规律以仿造的字符串，这个session id将被在本次响应中返回给客户端保存。 保存这个session id的方式可以采用cookie，这样在交互过程中浏览器可以自动的按照规则把这个标识发挥给服务器。一般这个cookie的名字都是类似于SEEESIONID。但cookie可以被人为的禁止，则必须有其他机制以便在cookie被禁止时仍然能够把session id传递回服务器。 


打完收工:p